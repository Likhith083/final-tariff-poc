# TariffAI Enterprise Makefile
# Comprehensive build, test, and deployment automation

.PHONY: help build test deploy clean docker-build docker-up docker-down
.PHONY: production development staging backup restore monitor logs
.PHONY: security audit performance health database migrate
.PHONY: setup install update maintenance

# Default target
help: ## Show this help message
	@echo "TariffAI Enterprise Management Commands"
	@echo "======================================"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# =============================================================================
# SETUP & INSTALLATION
# =============================================================================

setup: ## Initial project setup
	@echo "ğŸš€ Setting up TariffAI Enterprise..."
	mkdir -p data logs backups uploads static
	cp env.production.example .env.production
	@echo "âœ… Setup complete. Please edit .env.production with your configuration."

install: ## Install all dependencies
	@echo "ğŸ“¦ Installing dependencies..."
	cd backend && pip install -r requirements.production.txt
	cd frontend && npm ci --production
	@echo "âœ… Dependencies installed."

update: ## Update all dependencies
	@echo "ğŸ”„ Updating dependencies..."
	cd backend && pip install -r requirements.production.txt --upgrade
	cd frontend && npm update
	@echo "âœ… Dependencies updated."

# =============================================================================
# BUILD & COMPILATION
# =============================================================================

build: ## Build all components
	@echo "ğŸ”¨ Building TariffAI..."
	$(MAKE) build-backend
	$(MAKE) build-frontend
	@echo "âœ… Build complete."

build-backend: ## Build backend application
	@echo "ğŸ”¨ Building backend..."
	cd backend && python -m compileall .
	@echo "âœ… Backend built."

build-frontend: ## Build frontend application
	@echo "ğŸ”¨ Building frontend..."
	cd frontend && npm run build
	@echo "âœ… Frontend built."

build-production: ## Build for production
	@echo "ğŸ­ Building for production..."
	$(MAKE) build-backend
	$(MAKE) build-frontend
	docker-compose -f docker-compose.production.yml build
	@echo "âœ… Production build complete."

# =============================================================================
# TESTING
# =============================================================================

test: ## Run all tests
	@echo "ğŸ§ª Running tests..."
	$(MAKE) test-backend
	$(MAKE) test-frontend
	@echo "âœ… All tests completed."

test-backend: ## Run backend tests
	@echo "ğŸ§ª Testing backend..."
	cd backend && python -m pytest tests/ -v --cov=app --cov-report=html
	@echo "âœ… Backend tests completed."

test-frontend: ## Run frontend tests
	@echo "ğŸ§ª Testing frontend..."
	cd frontend && npm test -- --coverage --watchAll=false
	@echo "âœ… Frontend tests completed."

test-integration: ## Run integration tests
	@echo "ğŸ§ª Running integration tests..."
	docker-compose -f docker-compose.test.yml up --abort-on-container-exit
	@echo "âœ… Integration tests completed."

test-performance: ## Run performance tests
	@echo "âš¡ Running performance tests..."
	cd backend && python -m pytest tests/test_performance.py -v
	@echo "âœ… Performance tests completed."

test-security: ## Run security tests
	@echo "ğŸ”’ Running security tests..."
	cd backend && python -m pytest tests/test_security.py -v
	@echo "âœ… Security tests completed."

# =============================================================================
# DOCKER OPERATIONS
# =============================================================================

docker-build: ## Build Docker images
	@echo "ğŸ³ Building Docker images..."
	docker-compose build
	@echo "âœ… Docker images built."

docker-up: ## Start Docker services
	@echo "ğŸ³ Starting Docker services..."
	docker-compose up -d
	@echo "âœ… Docker services started."

docker-down: ## Stop Docker services
	@echo "ğŸ³ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Docker services stopped."

docker-clean: ## Clean Docker resources
	@echo "ğŸ§¹ Cleaning Docker resources..."
	docker-compose down -v --remove-orphans
	docker system prune -f
	@echo "âœ… Docker resources cleaned."

# =============================================================================
# PRODUCTION DEPLOYMENT
# =============================================================================

production: ## Deploy to production
	@echo "ğŸš€ Deploying to production..."
	$(MAKE) build-production
	$(MAKE) up-production
	$(MAKE) migrate
	$(MAKE) health-check
	@echo "âœ… Production deployment complete."

up-production: ## Start production services
	@echo "ğŸš€ Starting production services..."
	docker-compose -f docker-compose.production.yml up -d
	@echo "âœ… Production services started."

down-production: ## Stop production services
	@echo "ğŸ›‘ Stopping production services..."
	docker-compose -f docker-compose.production.yml down
	@echo "âœ… Production services stopped."

restart-production: ## Restart production services
	@echo "ğŸ”„ Restarting production services..."
	$(MAKE) down-production
	$(MAKE) up-production
	@echo "âœ… Production services restarted."

# =============================================================================
# DEVELOPMENT
# =============================================================================

development: ## Start development environment
	@echo "ğŸ› ï¸ Starting development environment..."
	docker-compose up -d
	@echo "âœ… Development environment started."

dev-backend: ## Start backend in development mode
	@echo "ğŸ› ï¸ Starting backend development server..."
	cd backend && python -m uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

dev-frontend: ## Start frontend in development mode
	@echo "ğŸ› ï¸ Starting frontend development server..."
	cd frontend && npm start

# =============================================================================
# DATABASE OPERATIONS
# =============================================================================

database: ## Database operations menu
	@echo "ğŸ—„ï¸ Database Operations:"
	@echo "  migrate     - Run database migrations"
	@echo "  backup      - Create database backup"
	@echo "  restore     - Restore from backup"
	@echo "  reset       - Reset database"
	@echo "  optimize    - Optimize database"

migrate: ## Run database migrations
	@echo "ğŸ—„ï¸ Running database migrations..."
	cd backend && alembic upgrade head
	@echo "âœ… Migrations completed."

backup: ## Create database backup
	@echo "ğŸ’¾ Creating database backup..."
	mkdir -p backups
	docker-compose exec postgres pg_dump -U tariff_user tariff_db > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup created."

backup-db: ## Create database backup (production)
	@echo "ğŸ’¾ Creating production database backup..."
	mkdir -p backups
	docker-compose -f docker-compose.production.yml exec postgres pg_dump -U tariff_user tariff_db > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Production backup created."

restore: ## Restore database from backup
	@echo "ğŸ”„ Restoring database from backup..."
	@read -p "Enter backup file name: " backup_file; \
	docker-compose exec postgres psql -U tariff_user tariff_db < backups/$$backup_file
	@echo "âœ… Database restored."

reset-db: ## Reset database
	@echo "ğŸ”„ Resetting database..."
	docker-compose exec postgres psql -U tariff_user -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;"
	$(MAKE) migrate
	@echo "âœ… Database reset."

optimize-db: ## Optimize database
	@echo "âš¡ Optimizing database..."
	docker-compose exec postgres psql -U tariff_user tariff_db -c "VACUUM ANALYZE;"
	@echo "âœ… Database optimized."

# =============================================================================
# MONITORING & HEALTH
# =============================================================================

monitor: ## Open monitoring dashboards
	@echo "ğŸ“Š Opening monitoring dashboards..."
	@echo "Grafana: http://localhost:3000"
	@echo "Prometheus: http://localhost:9090"
	@echo "Kibana: http://localhost:5601"

health-check: ## Check system health
	@echo "ğŸ¥ Checking system health..."
	curl -f http://localhost/health || echo "âŒ Health check failed"
	@echo "âœ… Health check completed."

status: ## Show service status
	@echo "ğŸ“Š Service Status:"
	docker-compose ps

logs: ## Show application logs
	@echo "ğŸ“‹ Application logs:"
	docker-compose logs -f

logs-backend: ## Show backend logs
	@echo "ğŸ“‹ Backend logs:"
	docker-compose logs -f backend

logs-frontend: ## Show frontend logs
	@echo "ğŸ“‹ Frontend logs:"
	docker-compose logs -f frontend

logs-production: ## Show production logs
	@echo "ğŸ“‹ Production logs:"
	docker-compose -f docker-compose.production.yml logs -f

# =============================================================================
# SECURITY & AUDIT
# =============================================================================

security: ## Security operations menu
	@echo "ğŸ”’ Security Operations:"
	@echo "  audit       - Run security audit"
	@echo "  scan        - Security vulnerability scan"
	@echo "  update      - Update security patches"

audit: ## Run security audit
	@echo "ğŸ”’ Running security audit..."
	cd backend && bandit -r app/
	cd frontend && npm audit
	@echo "âœ… Security audit completed."

security-scan: ## Run security vulnerability scan
	@echo "ğŸ”’ Running security vulnerability scan..."
	docker run --rm -v $(PWD):/app owasp/zap2docker-stable zap-baseline.py -t http://localhost
	@echo "âœ… Security scan completed."

update-security: ## Update security patches
	@echo "ğŸ”’ Updating security patches..."
	cd backend && pip install --upgrade pip
	cd frontend && npm audit fix
	@echo "âœ… Security patches updated."

# =============================================================================
# PERFORMANCE & OPTIMIZATION
# =============================================================================

performance: ## Performance operations menu
	@echo "âš¡ Performance Operations:"
	@echo "  analyze     - Analyze performance"
	@echo "  optimize    - Optimize system"
	@echo "  benchmark   - Run benchmarks"

analyze: ## Analyze performance
	@echo "âš¡ Analyzing performance..."
	cd backend && python -m pytest tests/test_performance.py -v
	@echo "âœ… Performance analysis completed."

optimize: ## Optimize system performance
	@echo "âš¡ Optimizing system performance..."
	$(MAKE) optimize-db
	docker-compose exec redis redis-cli FLUSHALL
	@echo "âœ… System optimization completed."

benchmark: ## Run performance benchmarks
	@echo "âš¡ Running performance benchmarks..."
	cd backend && python -m pytest tests/test_benchmark.py -v
	@echo "âœ… Performance benchmarks completed."

# =============================================================================
# MAINTENANCE
# =============================================================================

maintenance: ## Maintenance operations menu
	@echo "ğŸ”§ Maintenance Operations:"
	@echo "  weekly      - Weekly maintenance"
	@echo "  monthly     - Monthly maintenance"
	@echo "  cleanup     - System cleanup"

maintenance-weekly: ## Weekly maintenance tasks
	@echo "ğŸ”§ Running weekly maintenance..."
	$(MAKE) backup
	$(MAKE) optimize-db
	$(MAKE) cleanup-logs
	@echo "âœ… Weekly maintenance completed."

maintenance-monthly: ## Monthly maintenance tasks
	@echo "ğŸ”§ Running monthly maintenance..."
	$(MAKE) update
	$(MAKE) audit
	$(MAKE) performance-analyze
	@echo "âœ… Monthly maintenance completed."

cleanup: ## System cleanup
	@echo "ğŸ§¹ Running system cleanup..."
	$(MAKE) cleanup-logs
	$(MAKE) cleanup-cache
	$(MAKE) docker-clean
	@echo "âœ… System cleanup completed."

cleanup-logs: ## Clean up old logs
	@echo "ğŸ§¹ Cleaning up old logs..."
	find logs/ -name "*.log" -mtime +30 -delete
	@echo "âœ… Log cleanup completed."

cleanup-cache: ## Clean up cache
	@echo "ğŸ§¹ Cleaning up cache..."
	docker-compose exec redis redis-cli FLUSHALL
	@echo "âœ… Cache cleanup completed."

# =============================================================================
# UTILITIES
# =============================================================================

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf backend/__pycache__
	rm -rf frontend/build
	rm -rf frontend/node_modules
	@echo "âœ… Cleanup completed."

reset: ## Reset entire system
	@echo "ğŸ”„ Resetting entire system..."
	$(MAKE) docker-down
	$(MAKE) docker-clean
	$(MAKE) clean
	@echo "âœ… System reset completed."

debug-on: ## Enable debug mode
	@echo "ğŸ› Enabling debug mode..."
	sed -i 's/DEBUG=false/DEBUG=true/' .env.production
	@echo "âœ… Debug mode enabled."

debug-off: ## Disable debug mode
	@echo "ğŸ› Disabling debug mode..."
	sed -i 's/DEBUG=true/DEBUG=false/' .env.production
	@echo "âœ… Debug mode disabled."

# =============================================================================
# EMERGENCY OPERATIONS
# =============================================================================

emergency-stop: ## Emergency stop all services
	@echo "ğŸš¨ Emergency stop initiated..."
	docker-compose -f docker-compose.production.yml down
	@echo "âœ… Emergency stop completed."

emergency-restart: ## Emergency restart all services
	@echo "ğŸš¨ Emergency restart initiated..."
	$(MAKE) emergency-stop
	$(MAKE) up-production
	@echo "âœ… Emergency restart completed."

rollback: ## Rollback to previous version
	@echo "ğŸ”„ Rolling back to previous version..."
	git checkout HEAD~1
	$(MAKE) build-production
	$(MAKE) up-production
	@echo "âœ… Rollback completed."

# =============================================================================
# REPORTING
# =============================================================================

report: ## Generate system report
	@echo "ğŸ“Š Generating system report..."
	@echo "System Report - $(shell date)" > system_report.txt
	@echo "========================" >> system_report.txt
	$(MAKE) status >> system_report.txt
	@echo "âœ… System report generated: system_report.txt"

performance-report: ## Generate performance report
	@echo "ğŸ“Š Generating performance report..."
	cd backend && python -m pytest tests/test_performance.py --html=performance_report.html
	@echo "âœ… Performance report generated: performance_report.html"

compliance-report: ## Generate compliance report
	@echo "ğŸ“Š Generating compliance report..."
	cd backend && python -m pytest tests/test_compliance.py --html=compliance_report.html
	@echo "âœ… Compliance report generated: compliance_report.html"

# =============================================================================
# HELPERS
# =============================================================================

version: ## Show version information
	@echo "TariffAI Enterprise v1.0.0"
	@echo "Build: $(shell git rev-parse --short HEAD)"
	@echo "Date: $(shell date)"

info: ## Show system information
	@echo "System Information:"
	@echo "OS: $(shell uname -s)"
	@echo "Architecture: $(shell uname -m)"
	@echo "Docker: $(shell docker --version)"
	@echo "Python: $(shell python --version)"
	@echo "Node: $(shell node --version)"

# =============================================================================
# DEVELOPMENT HELPERS
# =============================================================================

dev-setup: ## Setup development environment
	@echo "ğŸ› ï¸ Setting up development environment..."
	$(MAKE) setup
	cd backend && pip install -r requirements.txt
	cd frontend && npm install
	@echo "âœ… Development environment setup complete."

dev-test: ## Run tests in development
	@echo "ğŸ§ª Running development tests..."
	$(MAKE) test-backend
	$(MAKE) test-frontend
	@echo "âœ… Development tests completed."

dev-lint: ## Run linting
	@echo "ğŸ” Running linting..."
	cd backend && black app/ && isort app/ && flake8 app/
	cd frontend && npm run lint
	@echo "âœ… Linting completed."

dev-format: ## Format code
	@echo "ğŸ¨ Formatting code..."
	cd backend && black app/ && isort app/
	cd frontend && npm run format
	@echo "âœ… Code formatting completed." 